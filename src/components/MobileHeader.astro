---
---

<header class="mobile-header">
  <div class="mobile-logo-wrapper">
    <img class="mobile-logo" src="/images/logo.svg" alt="VirÅ¡upis" />
  </div>
  <button class="mobile-menu-btn" aria-label="Menu">
    <img src="/images/Menu icon.svg" alt="" />
  </button>
</header>

<!-- Spacer to push content down on mobile -->
<div class="mobile-header-spacer"></div>

<style>
  :root {
    --sat: env(safe-area-inset-top, 0px);
  }

  .mobile-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: #F5F3EE;
    display: flex;
    align-items: flex-start;
    padding-top: calc(24px + env(safe-area-inset-top, 0px));
    padding-right: 16px;
    padding-bottom: 16px;
    padding-left: 16px;
    /* iOS fix: Force GPU compositing layer for stable fixed positioning */
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .mobile-logo-wrapper {
    width: 100%;
    aspect-ratio: 6.89 / 1;
  }

  .mobile-logo {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .mobile-menu-btn {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
  }

  .mobile-menu-btn img {
    display: block;
    width: 24px;
    height: auto;
  }

  .mobile-header-spacer {
    display: block;
    height: calc(120px + env(safe-area-inset-top, 0px));
  }

  @media (min-width: 768px) {
    .mobile-header,
    .mobile-header-spacer {
      display: none !important;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  ScrollTrigger.config({
    ignoreMobileResize: true,
  });

  // Initialize mobile header after layout is stable
  const initMobileHeader = () => {
    ScrollTrigger.matchMedia({
      "(max-width: 767px)": function () {
        const header = document.querySelector(".mobile-header") as HTMLElement;
        const logoWrapper = document.querySelector(".mobile-logo-wrapper") as HTMLElement;
        const menuBtn = document.querySelector(".mobile-menu-btn") as HTMLElement;
        const spacer = document.querySelector(".mobile-header-spacer") as HTMLElement;
        const aboutSection = document.getElementById("apie");

        if (!header || !logoWrapper || !menuBtn || !spacer) {
          console.warn("Mobile header elements not found");
          return function () {};
        }

        if (!aboutSection) {
          console.warn("About section #apie not found for mobile header animation");
          return function () {};
        }

        const logoAspectRatio = 6.89;
        const collapsedHeight = 63;
        const collapsedLogoWidth = 200;

        // Get safe area inset from CSS
        const getSafeAreaTop = () => {
          const value = getComputedStyle(document.documentElement).getPropertyValue('--sat');
          return value ? parseInt(value) : 0;
        };

        const getExpandedLogoWidth = () => window.innerWidth - 32;

        const getExpandedHeight = () => {
          const logoWidth = getExpandedLogoWidth();
          const logoHeight = logoWidth / logoAspectRatio;
          const safeArea = getSafeAreaTop();
          return 24 + safeArea + logoHeight + 16;
        };

        // Calculate collapsed padding to center the logo vertically
        const getCollapsedPadding = () => {
          const collapsedLogoHeight = collapsedLogoWidth / logoAspectRatio;
          const verticalPadding = (collapsedHeight - collapsedLogoHeight) / 2;
          return verticalPadding;
        };

        const setInitialState = () => {
          gsap.set(logoWrapper, { width: getExpandedLogoWidth() });
          gsap.set(menuBtn, { autoAlpha: 0 });
          gsap.set(spacer, { height: getExpandedHeight() });
          gsap.set(header, {
            height: getExpandedHeight(),
            paddingTop: 24 + getSafeAreaTop(),
            paddingBottom: 16
          });
        };

        setInitialState();

        // Track animation state
        let isCollapsed = false;

        // Collapse header function (spacer stays fixed to prevent layout shift)
        const collapseHeader = () => {
          gsap.to(logoWrapper, {
            width: collapsedLogoWidth,
            duration: 0.4,
            ease: "power2.out"
          });
          gsap.to(menuBtn, {
            autoAlpha: 1,
            duration: 0.3,
            ease: "power2.out"
          });
          gsap.to(header, {
            height: collapsedHeight + getSafeAreaTop(),
            paddingTop: getCollapsedPadding() + getSafeAreaTop(),
            paddingBottom: getCollapsedPadding(),
            duration: 0.4,
            ease: "power2.out"
          });
        };

        // Expand header function (spacer stays fixed to prevent layout shift)
        const expandHeader = () => {
          gsap.to(logoWrapper, {
            width: getExpandedLogoWidth(),
            duration: 0.4,
            ease: "power2.out"
          });
          gsap.to(menuBtn, {
            autoAlpha: 0,
            duration: 0.3,
            ease: "power2.out"
          });
          gsap.to(header, {
            height: getExpandedHeight(),
            paddingTop: 24 + getSafeAreaTop(),
            paddingBottom: 16,
            duration: 0.4,
            ease: "power2.out"
          });
        };

        // Create ScrollTrigger for state change
        // Triggers when top of #apie reaches 8% from top of viewport
        const trigger = ScrollTrigger.create({
          trigger: aboutSection,
          start: "top 8%",
          onEnter: () => {
            if (!isCollapsed) {
              isCollapsed = true;
              collapseHeader();
            }
          },
          onLeaveBack: () => {
            if (isCollapsed) {
              isCollapsed = false;
              expandHeader();
            }
          },
          invalidateOnRefresh: true
        });

        // Refresh to ensure accurate positions
        ScrollTrigger.refresh();

        // Check if already scrolled past trigger on page load (after refresh)
        requestAnimationFrame(() => {
          const rect = aboutSection.getBoundingClientRect();
          if (rect.top < window.innerHeight * 0.08) {
            isCollapsed = true;
            gsap.set(logoWrapper, { width: collapsedLogoWidth });
            gsap.set(menuBtn, { autoAlpha: 1 });
            gsap.set(header, {
              height: collapsedHeight + getSafeAreaTop(),
              paddingTop: getCollapsedPadding() + getSafeAreaTop(),
              paddingBottom: getCollapsedPadding()
            });
          }
        });

        return function () {
          trigger.kill();
        };
      },
    });
  };

  // Wait for load + 2 animation frames for layout stability
  if (document.readyState === 'complete') {
    requestAnimationFrame(() => requestAnimationFrame(initMobileHeader));
  } else {
    window.addEventListener('load', () => {
      requestAnimationFrame(() => requestAnimationFrame(initMobileHeader));
    });
  }

  let resizeTimeout: ReturnType<typeof setTimeout>;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => ScrollTrigger.refresh(), 100);
  });

  window.addEventListener("orientationchange", () => {
    setTimeout(() => ScrollTrigger.refresh(), 100);
  });
</script>
