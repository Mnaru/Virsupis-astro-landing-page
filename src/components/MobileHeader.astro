---
---

<header class="mobile-header">
  <div class="mobile-logo-wrapper">
    <img class="mobile-logo" src="/images/logo.svg" alt="Viršupis" />
  </div>
  <button class="mobile-menu-btn" aria-label="Menu">
    <img src="/images/Menu icon.svg" alt="" />
  </button>
</header>

<!-- Spacer to push content down on mobile -->
<div class="mobile-header-spacer"></div>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu-overlay" aria-hidden="true">
  <div class="mobile-menu-header">
    <div class="mobile-menu-logo-wrapper">
      <img src="/images/logo.svg" alt="Viršupis" />
    </div>
    <button class="mobile-menu-close" aria-label="Close menu">
      <img src="/images/Close icon.svg" alt="" />
    </button>
  </div>

  <nav class="mobile-menu-nav">
    <a href="#apie-nav" class="mobile-menu-item">APIE</a>
    <a href="https://maps.app.goo.gl/VrLXHLc5Ni44R8rA6" class="mobile-menu-item" target="_blank" rel="noopener noreferrer">ADRESAS</a>
    <a href="https://www.instagram.com/virsupis_vilnius/" class="mobile-menu-item" target="_blank" rel="noopener noreferrer">SEKTI</a>
    <a href="mailto:mindaugas@virsupis.com" class="mobile-menu-item">SUSISIEKTI</a>
  </nav>
</div>

<style>
  :root {
    --sat: env(safe-area-inset-top, 0px);
  }

  .mobile-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: #F5F3EE;
    display: flex;
    align-items: flex-start;
    padding-top: calc(24px + env(safe-area-inset-top, 0px));
    padding-right: 16px;
    padding-bottom: 16px;
    padding-left: 16px;
    /* iOS fix: Force GPU compositing layer for stable fixed positioning */
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .mobile-logo-wrapper {
    width: 100%;
    aspect-ratio: 6.89 / 1;
  }

  .mobile-logo {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .mobile-menu-btn {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
  }

  .mobile-menu-btn img {
    display: block;
    width: 24px;
    height: auto;
  }

  .mobile-header-spacer {
    display: block;
    height: calc(120px + env(safe-area-inset-top, 0px));
  }

  @media (min-width: 768px) {
    .mobile-header,
    .mobile-header-spacer {
      display: none !important;
    }
  }

  /* Mobile Menu Overlay */
  .mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 0;
    z-index: 200;
    background-color: #f8f4ee;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
  }

  /* Menu header matches collapsed mobile header exactly */
  /* Logo: 200px, aspect ratio 6.89:1 = ~29px height */
  /* Collapsed height: 63px, vertical padding: (63-29)/2 ≈ 17px */
  .mobile-menu-header {
    position: relative;
    display: flex;
    align-items: flex-start;
    height: calc(63px + env(safe-area-inset-top, 0px));
    padding-top: calc(17px + env(safe-area-inset-top, 0px));
    padding-right: 16px;
    padding-bottom: 17px;
    padding-left: 16px;
    flex-shrink: 0;
  }

  .mobile-menu-logo-wrapper {
    width: 200px;
    aspect-ratio: 6.89 / 1;
  }

  .mobile-menu-logo-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .mobile-menu-close {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .mobile-menu-close img {
    width: 100%;
    height: 100%;
  }

  .mobile-menu-nav {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 32px;
    padding: 42px 16px;
  }

  .mobile-menu-item {
    font-family: "General Sans", sans-serif;
    font-weight: 500;
    font-size: 21px;
    line-height: 1.1;
    letter-spacing: 4.2px;
    color: #161514;
    text-decoration: none;
    opacity: 0;
    transform: translateY(20px);
  }

  @media (min-width: 768px) {
    .mobile-menu-overlay {
      display: none !important;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // ScrollTrigger.config() is set globally in scrollTriggerInit.ts

  // Initialize mobile header after layout is stable
  const initMobileHeader = () => {
    ScrollTrigger.matchMedia({
      "(max-width: 767px)": function () {
        const header = document.querySelector(".mobile-header") as HTMLElement;
        const logoWrapper = document.querySelector(".mobile-logo-wrapper") as HTMLElement;
        const menuBtn = document.querySelector(".mobile-menu-btn") as HTMLElement;
        const spacer = document.querySelector(".mobile-header-spacer") as HTMLElement;
        const aboutSection = document.getElementById("apie");

        if (!header || !logoWrapper || !menuBtn || !spacer) {
          console.warn("Mobile header elements not found");
          return function () {};
        }

        if (!aboutSection) {
          console.warn("About section #apie not found for mobile header animation");
          return function () {};
        }

        const logoAspectRatio = 6.89;
        const collapsedHeight = 63;
        const collapsedLogoWidth = 200;

        // Get safe area inset from CSS
        const getSafeAreaTop = () => {
          const value = getComputedStyle(document.documentElement).getPropertyValue('--sat');
          return value ? parseInt(value) : 0;
        };

        const getExpandedLogoWidth = () => window.innerWidth - 32;

        const getExpandedHeight = () => {
          const logoWidth = getExpandedLogoWidth();
          const logoHeight = logoWidth / logoAspectRatio;
          const safeArea = getSafeAreaTop();
          return 24 + safeArea + logoHeight + 16;
        };

        // Calculate collapsed padding to center the logo vertically
        const getCollapsedPadding = () => {
          const collapsedLogoHeight = collapsedLogoWidth / logoAspectRatio;
          const verticalPadding = (collapsedHeight - collapsedLogoHeight) / 2;
          return verticalPadding;
        };

        const setInitialState = () => {
          gsap.set(logoWrapper, { width: getExpandedLogoWidth() });
          gsap.set(menuBtn, { autoAlpha: 0 });
          gsap.set(spacer, { height: getExpandedHeight() });
          gsap.set(header, {
            height: getExpandedHeight(),
            paddingTop: 24 + getSafeAreaTop(),
            paddingBottom: 16
          });
        };

        setInitialState();

        // Track animation state
        let isCollapsed = false;

        // Collapse header function (spacer stays fixed to prevent layout shift)
        const collapseHeader = () => {
          gsap.to(logoWrapper, {
            width: collapsedLogoWidth,
            duration: 0.4,
            ease: "power2.out"
          });
          gsap.to(menuBtn, {
            autoAlpha: 1,
            duration: 0.3,
            ease: "power2.out"
          });
          gsap.to(header, {
            height: collapsedHeight + getSafeAreaTop(),
            paddingTop: getCollapsedPadding() + getSafeAreaTop(),
            paddingBottom: getCollapsedPadding(),
            duration: 0.4,
            ease: "power2.out"
          });
        };

        // Expand header function (spacer stays fixed to prevent layout shift)
        const expandHeader = () => {
          gsap.to(logoWrapper, {
            width: getExpandedLogoWidth(),
            duration: 0.4,
            ease: "power2.out"
          });
          gsap.to(menuBtn, {
            autoAlpha: 0,
            duration: 0.3,
            ease: "power2.out"
          });
          gsap.to(header, {
            height: getExpandedHeight(),
            paddingTop: 24 + getSafeAreaTop(),
            paddingBottom: 16,
            duration: 0.4,
            ease: "power2.out"
          });
        };

        // Create ScrollTrigger for state change
        // Triggers when top of #apie reaches 8% from top of viewport
        const trigger = ScrollTrigger.create({
          trigger: aboutSection,
          start: "top 8%",
          onEnter: () => {
            if (!isCollapsed) {
              isCollapsed = true;
              collapseHeader();
            }
          },
          onLeaveBack: () => {
            if (isCollapsed) {
              isCollapsed = false;
              expandHeader();
            }
          },
          invalidateOnRefresh: true
        });

        // Refresh to ensure accurate positions
        ScrollTrigger.refresh();

        // Check if already scrolled past trigger on page load (after refresh)
        requestAnimationFrame(() => {
          const rect = aboutSection.getBoundingClientRect();
          if (rect.top < window.innerHeight * 0.08) {
            isCollapsed = true;
            gsap.set(logoWrapper, { width: collapsedLogoWidth });
            gsap.set(menuBtn, { autoAlpha: 1 });
            gsap.set(header, {
              height: collapsedHeight + getSafeAreaTop(),
              paddingTop: getCollapsedPadding() + getSafeAreaTop(),
              paddingBottom: getCollapsedPadding()
            });
          }
        });

        return function () {
          trigger.kill();
        };
      },
    });
  };

  // Wait for load + 2 animation frames for layout stability
  if (document.readyState === 'complete') {
    requestAnimationFrame(() => requestAnimationFrame(initMobileHeader));
  } else {
    window.addEventListener('load', () => {
      requestAnimationFrame(() => requestAnimationFrame(initMobileHeader));
    });
  }

  // Resize/orientationchange handlers are set globally in scrollTriggerInit.ts

  // ============================================
  // Mobile Menu Functionality
  // ============================================

  const menuOverlay = document.querySelector('.mobile-menu-overlay') as HTMLElement;
  const menuItems = document.querySelectorAll('.mobile-menu-item');
  const closeBtn = document.querySelector('.mobile-menu-close') as HTMLElement;
  const menuBtn = document.querySelector('.mobile-menu-btn') as HTMLElement;

  let isMenuOpen = false;

  // Open menu function
  function openMenu() {
    if (isMenuOpen || !menuOverlay) return;
    isMenuOpen = true;

    // Lock body scroll
    document.body.style.overflow = 'hidden';
    menuOverlay.setAttribute('aria-hidden', 'false');

    // Animate overlay expansion
    gsap.to(menuOverlay, {
      height: '100dvh',
      duration: 0.4,
      ease: 'power2.out'
    });

    // Animate menu items with stagger
    gsap.to(menuItems, {
      opacity: 1,
      y: 0,
      duration: 0.3,
      stagger: 0.1,
      delay: 0.2,
      ease: 'power2.out'
    });
  }

  // Close menu function
  function closeMenu() {
    if (!isMenuOpen || !menuOverlay) return;
    isMenuOpen = false;

    // Fade out menu items
    gsap.to(menuItems, {
      opacity: 0,
      duration: 0.15,
      ease: 'power2.in'
    });

    // Contract overlay
    gsap.to(menuOverlay, {
      height: 0,
      duration: 0.3,
      delay: 0.1,
      ease: 'power2.in',
      onComplete: () => {
        document.body.style.overflow = '';
        menuOverlay.setAttribute('aria-hidden', 'true');
        // Reset menu items for next open
        gsap.set(menuItems, { opacity: 0, y: 20 });
      }
    });
  }

  // Event listeners
  menuBtn?.addEventListener('click', openMenu);
  closeBtn?.addEventListener('click', closeMenu);

  // Close on menu item click
  menuItems.forEach(item => {
    item.addEventListener('click', () => {
      closeMenu();
    });
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isMenuOpen) {
      closeMenu();
    }
  });
</script>
