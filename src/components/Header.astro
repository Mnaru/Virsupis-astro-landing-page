---
import Logo from "./Logo.astro";
import NavButton from "./NavButton.astro";
---

<header id="site-header" class="header hidden md:block">
  <div id="header-inner" class="header-inner">
    <!-- Menu items positioned absolutely - they never move (hidden on mobile) -->
    <nav class="nav-left" aria-label="Pagrindinė navigacija">
      <NavButton href="#apie" label="Apie" />
      <NavButton href="#namai" label="Namai" />
    </nav>

    <nav class="nav-right">
      <NavButton href="#vieta" label="Vieta" />
      <NavButton href="#kontaktai" label="Kontaktai" />
    </nav>

    <!-- Logo - CSS handles responsive sizing, GSAP animates collapse -->
    <a href="/preview" id="header-logo" class="header-logo" aria-label="Viršupis - Į pradžią">
      <Logo class="logo-img" />
    </a>

  </div>
</header>

<!-- Spacer to push content down -->
<div id="header-spacer" class="header-spacer hidden md:block"></div>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: #f8f4ee;
    overflow: hidden;
  }

  .header-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 24px 16px;
    position: relative;
    /* Height will be animated by GSAP */
  }

  /* Navigation - absolutely positioned, never moves */
  .nav-left,
  .nav-right {
    position: absolute;
    top: 16px;
    display: flex;
    align-items: center;
    gap: 42px;
    height: 37px;
    z-index: 2;
  }

  .nav-left {
    left: 24px;
  }

  .nav-right {
    right: 24px;
  }

  /* Logo - CSS handles responsive sizing */
  .header-logo {
    display: block;
    /* Expanded: full width minus padding, capped at 1392px (logo native width) */
    width: calc(100vw - 48px);
    max-width: 1392px;
    margin-top: 37px; /* Space below nav items */
    pointer-events: auto;
    /* Width will be animated by GSAP */
  }

  .logo-img {
    width: 100%;
    height: auto;
  }

  /* Spacer - height will be animated by GSAP */
  .header-spacer {
    /* Initial height set by GSAP */
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // Prevent scroll recalculation on mobile toolbar show/hide
  ScrollTrigger.config({
    ignoreMobileResize: true,
  });

  // Get elements
  const header = document.getElementById("site-header");
  const headerInner = document.getElementById("header-inner");
  const logo = document.getElementById("header-logo");
  const spacer = document.getElementById("header-spacer");

  if (header && headerInner && logo && spacer) {
    // Logo aspect ratio (1392 / 202)
    const logoAspectRatio = 6.89;

    // Get expanded logo width (CSS: calc(100vw - 48px), max 1392px)
    const getExpandedLogoWidth = () => {
      return Math.min(window.innerWidth - 48, 1392);
    };

    // Calculate header height based on logo height + spacing
    const getExpandedHeight = () => {
      const logoWidth = getExpandedLogoWidth();
      const logoHeight = logoWidth / logoAspectRatio;
      return 16 + 37 + logoHeight + 16; // top padding + logo margin-top + logo height + bottom padding
    };

    const getSpacerHeight = () => {
      return getExpandedHeight() + 16;
    };

    // Collapsed state values
    const getCollapsedLogoWidth = () => 318;
    const getCollapsedHeight = () => 63;
    const getCollapsedSpacerHeight = () => 79;

    const getCollapsedMarginTop = () => {
      const collapsedLogoWidth = getCollapsedLogoWidth();
      const collapsedLogoHeight = collapsedLogoWidth / logoAspectRatio;
      const collapsedHeight = getCollapsedHeight();
      return (collapsedHeight - collapsedLogoHeight) / 2 - 16;
    };

    // Set initial state (expanded)
    const setInitialState = () => {
      gsap.set(logo, {
        width: getExpandedLogoWidth(),
        marginTop: 37,
        x: 0,
      });
      gsap.set(headerInner, { height: getExpandedHeight() });
      gsap.set(spacer, { height: getSpacerHeight() });
    };

    // Set initial state
    setInitialState();

    const scrollTriggerDistance = 100;

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: document.body,
        start: "top top",
        end: `+=${scrollTriggerDistance}`,
        scrub: 0.5,
        invalidateOnRefresh: true,
        onRefresh: () => {
          if (window.scrollY === 0) {
            setInitialState();
          }
        },
      },
    });

    // Animate from expanded to collapsed
    tl.fromTo(
      logo,
      {
        width: () => getExpandedLogoWidth(),
        marginTop: 37,
        x: 0,
      },
      {
        width: () => getCollapsedLogoWidth(),
        marginTop: () => getCollapsedMarginTop(),
        x: 0,
        ease: "none",
      },
      0
    )
      .fromTo(
        headerInner,
        {
          height: () => getExpandedHeight(),
        },
        {
          height: () => getCollapsedHeight(),
          ease: "none",
        },
        0
      )
      .fromTo(
        spacer,
        {
          height: () => getSpacerHeight(),
        },
        {
          height: () => getCollapsedSpacerHeight(),
          ease: "none",
        },
        0
      );

    // Refresh ScrollTrigger after setup to ensure proper initialization on mobile
    ScrollTrigger.refresh();

    // Debounced resize handler
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => ScrollTrigger.refresh(), 100);
    });

    // Also refresh on orientation change
    window.addEventListener("orientationchange", () => {
      setTimeout(() => ScrollTrigger.refresh(), 100);
    });
  }
</script>
