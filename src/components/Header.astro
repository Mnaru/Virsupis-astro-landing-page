---
import Logo from "./Logo.astro";
import NavButton from "./NavButton.astro";
---

<header id="site-header" class="header">
  <div id="header-inner" class="header-inner">
    <!-- Menu items positioned absolutely - they never move (hidden on mobile) -->
    <nav class="nav-left" aria-label="Pagrindinė navigacija">
      <NavButton href="#apie" label="Apie" />
      <NavButton href="#namai" label="Namai" />
    </nav>

    <nav class="nav-right">
      <NavButton href="#vieta" label="Vieta" />
      <NavButton href="#kontaktai" label="Kontaktai" />
    </nav>

    <!-- Logo - CSS handles responsive sizing, GSAP animates collapse -->
    <a href="/preview" id="header-logo" class="header-logo" aria-label="Viršupis - Į pradžią">
      <Logo class="logo-img" />
    </a>

    <!-- Hamburger menu icon (mobile only) -->
    <button id="hamburger-btn" class="hamburger-btn" aria-label="Atidaryti meniu" aria-expanded="false">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
  </div>
</header>

<!-- Spacer to push content down -->
<div id="header-spacer" class="header-spacer"></div>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: #f8f4ee;
    overflow: hidden;
  }

  .header-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 24px 16px;
    position: relative;
    /* Height will be animated by GSAP */
  }

  /* Navigation - absolutely positioned, never moves */
  .nav-left,
  .nav-right {
    position: absolute;
    top: 16px;
    display: flex;
    align-items: center;
    gap: 42px;
    height: 37px;
    z-index: 2;
  }

  .nav-left {
    left: 24px;
  }

  .nav-right {
    right: 24px;
  }

  /* Logo - CSS handles responsive sizing */
  .header-logo {
    display: block;
    /* Expanded: full width minus padding, capped at 1392px (logo native width) */
    width: calc(100vw - 48px);
    max-width: 1392px;
    margin-top: 37px; /* Space below nav items */
    pointer-events: auto;
    /* Width will be animated by GSAP */
  }

  .logo-img {
    width: 100%;
    height: auto;
  }

  /* Spacer - height will be animated by GSAP */
  .header-spacer {
    /* Initial height set by GSAP */
  }

  /* Hamburger button - hidden on desktop */
  .hamburger-btn {
    display: none;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 18px;
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
    flex-direction: column;
    justify-content: space-between;
    z-index: 3;
    opacity: 0; /* Will be animated by GSAP */
  }

  .hamburger-line {
    display: block;
    width: 100%;
    height: 2px;
    background-color: var(--color-black, #161514);
    border-radius: 1px;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .header {
      position: fixed;
      top: env(safe-area-inset-top, 0px);
      left: 0;
      right: 0;
      z-index: 100;
      /* GPU compositing for iOS address bar tracking */
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    .header-inner {
      padding: 16px;
      flex-direction: row;
      justify-content: center;
      align-items: center;
    }

    /* Hide desktop nav items on mobile */
    .nav-left,
    .nav-right {
      display: none;
    }

    /* Logo - full width in expanded, animated by GSAP */
    .header-logo {
      width: calc(100vw - 32px);
      max-width: none;
      margin-top: 0;
      /* GSAP will handle width and position animation */
    }

    /* Show hamburger on mobile */
    .hamburger-btn {
      display: flex;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // Prevent scroll recalculation on mobile toolbar show/hide
  ScrollTrigger.config({
    ignoreMobileResize: true,
  });

  // Get elements
  const header = document.getElementById("site-header");
  const headerInner = document.getElementById("header-inner");
  const logo = document.getElementById("header-logo");
  const spacer = document.getElementById("header-spacer");
  const hamburger = document.getElementById("hamburger-btn");
  const aboutSection = document.querySelector(".about-section");

  if (header && headerInner && logo && spacer) {
    // Logo aspect ratio (1392 / 202)
    const logoAspectRatio = 6.89;

    // Desktop: Get expanded logo width (CSS: calc(100vw - 48px), max 1392px)
    const getExpandedLogoWidth = (mobile: boolean) => {
      if (mobile) {
        return window.innerWidth - 32; // Mobile: full width minus 16px padding each side
      }
      return Math.min(window.innerWidth - 48, 1392);
    };

    // Calculate header height based on logo height + spacing
    const getExpandedHeight = (mobile: boolean) => {
      const logoWidth = getExpandedLogoWidth(mobile);
      const logoHeight = logoWidth / logoAspectRatio;
      if (mobile) {
        return 32 + logoHeight; // 16px padding top + logo + 16px padding bottom
      }
      return 16 + 37 + logoHeight + 16; // Desktop: top padding + logo margin-top + logo height + bottom padding
    };

    const getSpacerHeight = (mobile: boolean) => {
      return getExpandedHeight(mobile) + 16;
    };

    // Collapsed state values
    const getCollapsedLogoWidth = (mobile: boolean) => {
      if (mobile) {
        return 180; // Smaller logo on mobile collapsed
      }
      return 318; // Desktop collapsed
    };

    const getCollapsedHeight = (mobile: boolean) => {
      if (mobile) {
        return 56; // Mobile collapsed header height
      }
      return 63; // Desktop collapsed
    };

    const getCollapsedSpacerHeight = (mobile: boolean) => {
      if (mobile) {
        return 72;
      }
      return 79;
    };

    const getCollapsedMarginTop = (mobile: boolean) => {
      const collapsedLogoWidth = getCollapsedLogoWidth(mobile);
      const collapsedLogoHeight = collapsedLogoWidth / logoAspectRatio;
      const collapsedHeight = getCollapsedHeight(mobile);
      if (mobile) {
        return 0; // No margin on mobile
      }
      return (collapsedHeight - collapsedLogoHeight) / 2 - 16;
    };

    // Set initial state (expanded)
    const setInitialState = (mobile: boolean) => {
      gsap.set(logo, {
        width: getExpandedLogoWidth(mobile),
        marginTop: mobile ? 0 : 37,
        x: 0,
      });
      gsap.set(headerInner, { height: getExpandedHeight(mobile) });
      gsap.set(spacer, { height: getSpacerHeight(mobile) });
      if (hamburger) {
        gsap.set(hamburger, { opacity: 0 });
      }
    };

    // Use matchMedia for different triggers on mobile vs desktop
    ScrollTrigger.matchMedia({
      // Desktop: trigger immediately on scroll
      "(min-width: 769px)": function () {
        setInitialState(false);

        const scrollTriggerDistance = 100;

        const tl = gsap.timeline({
          scrollTrigger: {
            trigger: document.body,
            start: "top top",
            end: `+=${scrollTriggerDistance}`,
            scrub: 0.5,
            invalidateOnRefresh: true,
            onRefresh: () => {
              if (window.scrollY === 0) {
                setInitialState(false);
              }
            },
          },
        });

        // Animate from expanded to collapsed
        tl.fromTo(
          logo,
          {
            width: () => getExpandedLogoWidth(false),
            marginTop: 37,
            x: 0,
          },
          {
            width: () => getCollapsedLogoWidth(false),
            marginTop: () => getCollapsedMarginTop(false),
            x: 0,
            ease: "none",
          },
          0
        )
          .fromTo(
            headerInner,
            {
              height: () => getExpandedHeight(false),
            },
            {
              height: () => getCollapsedHeight(false),
              ease: "none",
            },
            0
          )
          .fromTo(
            spacer,
            {
              height: () => getSpacerHeight(false),
            },
            {
              height: () => getCollapsedSpacerHeight(false),
              ease: "none",
            },
            0
          );
      },

      // Mobile: trigger when About section enters viewport
      "(max-width: 768px)": function () {
        setInitialState(true);

        if (aboutSection) {
          const tl = gsap.timeline({
            scrollTrigger: {
              trigger: aboutSection,
              start: "top bottom", // When top of About hits bottom of viewport
              end: "top 70%", // When top of About is 70% from top of viewport
              scrub: 0.5,
              invalidateOnRefresh: true,
              onRefresh: () => {
                // Check if we're above the About section
                const aboutTop = aboutSection.getBoundingClientRect().top;
                if (aboutTop > window.innerHeight) {
                  setInitialState(true);
                }
              },
            },
          });

          // Animate from expanded to collapsed
          tl.fromTo(
            logo,
            {
              width: () => getExpandedLogoWidth(true),
              marginTop: 0,
              x: 0,
            },
            {
              width: () => getCollapsedLogoWidth(true),
              marginTop: 0,
              x: () => -(window.innerWidth - 32 - getCollapsedLogoWidth(true)) / 2,
              ease: "none",
            },
            0
          )
            .fromTo(
              headerInner,
              {
                height: () => getExpandedHeight(true),
              },
              {
                height: () => getCollapsedHeight(true),
                ease: "none",
              },
              0
            )
            .fromTo(
              spacer,
              {
                height: () => getSpacerHeight(true),
              },
              {
                height: () => getCollapsedSpacerHeight(true),
                ease: "none",
              },
              0
            );

          // Animate hamburger on mobile
          if (hamburger) {
            tl.fromTo(hamburger, { opacity: 0 }, { opacity: 1, ease: "none" }, 0);
          }
        }
      },
    });

    // Refresh ScrollTrigger after setup to ensure proper initialization on mobile
    ScrollTrigger.refresh();

    // Debounced resize handler
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => ScrollTrigger.refresh(), 100);
    });

    // Also refresh on orientation change
    window.addEventListener("orientationchange", () => {
      setTimeout(() => ScrollTrigger.refresh(), 100);
    });
  }
</script>
