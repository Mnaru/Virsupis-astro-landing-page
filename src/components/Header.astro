---
import Logo from "./Logo.astro";
import NavButton from "./NavButton.astro";
---

<header id="site-header" class="header hidden md:block">
  <div id="header-inner" class="header-inner">
    <!-- Menu items positioned absolutely - they never move (hidden on mobile) -->
    <nav class="nav-left" aria-label="Pagrindinė navigacija">
      <NavButton href="#apie" label="Apie" />
      <NavButton href="https://maps.app.goo.gl/VrLXHLc5Ni44R8rA6" label="Adresas" external={true} />
    </nav>

    <nav class="nav-right">
      <NavButton href="https://www.instagram.com/virsupis_vilnius/" label="Instagram" external={true} />
      <NavButton href="mailto:mindaugas@virsupis.com" label="Susisiekti" />
    </nav>

    <!-- Logo - CSS handles responsive sizing, GSAP animates collapse -->
    <a href="/preview" id="header-logo" class="header-logo" aria-label="Viršupis - Į pradžią">
      <Logo class="logo-img" />
    </a>

  </div>
</header>

<!-- Spacer to push content down -->
<div id="header-spacer" class="header-spacer hidden md:block"></div>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: #f8f4ee;
    overflow: hidden;
  }

  .header-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 24px 16px;
    position: relative;
    /* Height will be animated by GSAP */
  }

  /* Navigation - absolutely positioned, never moves */
  .nav-left,
  .nav-right {
    position: absolute;
    top: 16px;
    display: flex;
    align-items: center;
    gap: 42px;
    height: 37px;
    z-index: 2;
  }

  .nav-left {
    left: 24px;
  }

  .nav-right {
    right: 24px;
  }

  /* Logo - absolutely positioned for precise control */
  .header-logo {
    display: block;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    /* Expanded: full width minus padding, capped at 1392px (logo native width) */
    width: calc(100vw - 48px);
    max-width: 1392px;
    top: 53px; /* 16px padding + 37px margin */
    pointer-events: auto;
    /* Width and position will be animated by GSAP */
  }

  .logo-img {
    width: 100%;
    height: auto;
  }

  /* Spacer - height will be animated by GSAP */
  .header-spacer {
    /* Initial height set by GSAP */
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // Prevent scroll recalculation on mobile toolbar show/hide
  ScrollTrigger.config({
    ignoreMobileResize: true,
  });

  // Get elements
  const header = document.getElementById("site-header");
  const headerInner = document.getElementById("header-inner");
  const logo = document.getElementById("header-logo");
  const spacer = document.getElementById("header-spacer");

  if (header && headerInner && logo && spacer) {
    // Logo aspect ratio (1392 / 202)
    const logoAspectRatio = 6.89;

    // Get expanded logo width (CSS: calc(100vw - 48px), max 1392px)
    const getExpandedLogoWidth = () => {
      return Math.min(window.innerWidth - 48, 1392);
    };

    // Calculate header height based on logo height + spacing
    const getExpandedHeight = () => {
      const logoWidth = getExpandedLogoWidth();
      const logoHeight = logoWidth / logoAspectRatio;
      return 16 + 37 + logoHeight + 16; // top padding + logo margin-top + logo height + bottom padding
    };

    const getSpacerHeight = () => {
      return getExpandedHeight() + 16;
    };

    // Collapsed state values
    const getCollapsedLogoWidth = () => 318;
    const getCollapsedHeight = () => 63;
    const getCollapsedSpacerHeight = () => 79;

    // Calculate collapsed top position to vertically center logo
    const getCollapsedTop = () => {
      const collapsedLogoWidth = getCollapsedLogoWidth();
      const collapsedLogoHeight = collapsedLogoWidth / logoAspectRatio;
      const collapsedHeight = getCollapsedHeight();
      return (collapsedHeight - collapsedLogoHeight) / 2;
    };

    // Set initial state (expanded)
    const setInitialState = () => {
      gsap.set(logo, {
        width: getExpandedLogoWidth(),
        top: 53, // 16px padding + 37px space
        left: '50%',
        xPercent: -50,
      });
      gsap.set(headerInner, { height: getExpandedHeight() });
      gsap.set(spacer, { height: getSpacerHeight() });
    };

    // Set initial state
    setInitialState();

    // Track animation state
    let isCollapsed = false;

    // Collapse header function (spacer stays fixed to prevent layout shift)
    const collapseHeader = () => {
      gsap.to(logo, {
        width: getCollapsedLogoWidth(),
        top: getCollapsedTop(),
        left: '50%',
        xPercent: -50,
        duration: 0.3,
        ease: "power2.inOut",
        overwrite: true
      });
      gsap.to(headerInner, {
        height: getCollapsedHeight(),
        duration: 0.3,
        ease: "power2.inOut",
        overwrite: true
      });
    };

    // Expand header function (spacer stays fixed to prevent layout shift)
    const expandHeader = () => {
      gsap.to(logo, {
        width: getExpandedLogoWidth(),
        top: 53,
        left: '50%',
        xPercent: -50,
        duration: 0.3,
        ease: "power2.inOut",
        overwrite: true
      });
      gsap.to(headerInner, {
        height: getExpandedHeight(),
        duration: 0.3,
        ease: "power2.inOut",
        overwrite: true
      });
    };

    // Initialize ScrollTrigger after layout is stable
    const initScrollTrigger = () => {
      const aboutSection = document.getElementById("apie");

      if (!aboutSection) {
        console.warn("About section #apie not found for header animation");
        return;
      }

      // Create ScrollTrigger for state change
      // Triggers when top of #apie reaches 8% from top of viewport
      ScrollTrigger.create({
        trigger: aboutSection,
        start: "top 15%",
        markers: true,
        onEnter: () => {
          if (!isCollapsed) {
            isCollapsed = true;
            collapseHeader();
          }
        },
        onLeaveBack: () => {
          if (isCollapsed) {
            isCollapsed = false;
            expandHeader();
          }
        },
        invalidateOnRefresh: true
      });

      // Refresh to ensure accurate positions
      ScrollTrigger.refresh();

      // Check if already scrolled past trigger on page load (after refresh)
      requestAnimationFrame(() => {
        const rect = aboutSection.getBoundingClientRect();
        if (rect.top < window.innerHeight * 0.15) {
          isCollapsed = true;
          gsap.set(logo, { width: getCollapsedLogoWidth(), top: getCollapsedTop(), left: '50%', xPercent: -50 });
          gsap.set(headerInner, { height: getCollapsedHeight() });
        }
      });
    };

    // Wait for load + 2 animation frames for layout stability
    if (document.readyState === 'complete') {
      requestAnimationFrame(() => requestAnimationFrame(initScrollTrigger));
    } else {
      window.addEventListener('load', () => {
        requestAnimationFrame(() => requestAnimationFrame(initScrollTrigger));
      });
    }

    // Debounced resize handler
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => ScrollTrigger.refresh(), 100);
    });

    // Also refresh on orientation change
    window.addEventListener("orientationchange", () => {
      setTimeout(() => ScrollTrigger.refresh(), 100);
    });
  }
</script>
