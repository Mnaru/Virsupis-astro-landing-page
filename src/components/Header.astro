---
import Logo from "./Logo.astro";
import NavButton from "./NavButton.astro";
---

<header id="site-header" class="header">
  <div id="header-inner" class="header-inner">
    <!-- Menu items positioned absolutely - they never move (hidden on mobile) -->
    <nav class="nav-left" aria-label="Pagrindinė navigacija">
      <NavButton href="#apie" label="Apie" />
      <NavButton href="#namai" label="Namai" />
    </nav>

    <nav class="nav-right">
      <NavButton href="#vieta" label="Vieta" />
      <NavButton href="#kontaktai" label="Kontaktai" />
    </nav>

    <!-- Logo - CSS handles responsive sizing, GSAP animates collapse -->
    <a href="/preview" id="header-logo" class="header-logo" aria-label="Viršupis - Į pradžią">
      <Logo class="logo-img" />
    </a>

    <!-- Hamburger menu icon (mobile only) -->
    <button id="hamburger-btn" class="hamburger-btn" aria-label="Atidaryti meniu" aria-expanded="false">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
  </div>
</header>

<!-- Spacer to push content down -->
<div id="header-spacer" class="header-spacer"></div>

<style>
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background-color: #f8f4ee;
    overflow: hidden;
  }

  .header-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 24px 16px;
    position: relative;
    /* Height will be animated by GSAP */
  }

  /* Navigation - absolutely positioned, never moves */
  .nav-left,
  .nav-right {
    position: absolute;
    top: 16px;
    display: flex;
    align-items: center;
    gap: 42px;
    height: 37px;
    z-index: 2;
  }

  .nav-left {
    left: 24px;
  }

  .nav-right {
    right: 24px;
  }

  /* Logo - CSS handles responsive sizing */
  .header-logo {
    display: block;
    /* Expanded: full width minus padding, capped at 1392px (logo native width) */
    width: calc(100vw - 48px);
    max-width: 1392px;
    margin-top: 37px; /* Space below nav items */
    pointer-events: auto;
    /* Width will be animated by GSAP */
  }

  .logo-img {
    width: 100%;
    height: auto;
  }

  /* Spacer - height will be animated by GSAP */
  .header-spacer {
    /* Initial height set by GSAP */
  }

  /* Hamburger button - hidden on desktop */
  .hamburger-btn {
    display: none;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 18px;
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
    flex-direction: column;
    justify-content: space-between;
    z-index: 3;
    opacity: 0; /* Will be animated by GSAP */
  }

  .hamburger-line {
    display: block;
    width: 100%;
    height: 2px;
    background-color: var(--color-black, #161514);
    border-radius: 1px;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .header-inner {
      padding: 16px;
      flex-direction: row;
      justify-content: center;
      align-items: center;
    }

    /* Hide desktop nav items on mobile */
    .nav-left,
    .nav-right {
      display: none;
    }

    /* Logo - full width in expanded, animated by GSAP */
    .header-logo {
      width: calc(100vw - 32px);
      max-width: none;
      margin-top: 0;
      /* GSAP will handle width and position animation */
    }

    /* Show hamburger on mobile */
    .hamburger-btn {
      display: flex;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  // Get elements
  const header = document.getElementById("site-header");
  const headerInner = document.getElementById("header-inner");
  const logo = document.getElementById("header-logo");
  const spacer = document.getElementById("header-spacer");
  const hamburger = document.getElementById("hamburger-btn");

  if (header && headerInner && logo && spacer) {
    // Logo aspect ratio (1392 / 202)
    const logoAspectRatio = 6.89;
    const mobileBreakpoint = 768;

    const isMobile = () => window.innerWidth <= mobileBreakpoint;

    // Desktop: Get expanded logo width (CSS: calc(100vw - 48px), max 1392px)
    const getExpandedLogoWidth = () => {
      if (isMobile()) {
        return window.innerWidth - 32; // Mobile: full width minus 16px padding each side
      }
      return Math.min(window.innerWidth - 48, 1392);
    };

    // Calculate header height based on logo height + spacing
    const getExpandedHeight = () => {
      const logoWidth = getExpandedLogoWidth();
      const logoHeight = logoWidth / logoAspectRatio;
      if (isMobile()) {
        return 32 + logoHeight; // 16px padding top + logo + 16px padding bottom
      }
      return 16 + 37 + logoHeight + 16; // Desktop: top padding + logo margin-top + logo height + bottom padding
    };

    const getSpacerHeight = () => {
      return getExpandedHeight() + 16;
    };

    // Collapsed state values
    const getCollapsedLogoWidth = () => {
      if (isMobile()) {
        return 180; // Smaller logo on mobile collapsed
      }
      return 318; // Desktop collapsed
    };

    const getCollapsedHeight = () => {
      if (isMobile()) {
        return 56; // Mobile collapsed header height
      }
      return 63; // Desktop collapsed
    };

    const getCollapsedSpacerHeight = () => {
      if (isMobile()) {
        return 72;
      }
      return 79;
    };

    const getCollapsedMarginTop = () => {
      const collapsedLogoWidth = getCollapsedLogoWidth();
      const collapsedLogoHeight = collapsedLogoWidth / logoAspectRatio;
      const collapsedHeight = getCollapsedHeight();
      if (isMobile()) {
        return 0; // No margin on mobile
      }
      return (collapsedHeight - collapsedLogoHeight) / 2 - 16;
    };

    // Set initial state (expanded)
    const setInitialState = () => {
      gsap.set(logo, {
        width: getExpandedLogoWidth(),
        marginTop: isMobile() ? 0 : 37,
        x: 0,
      });
      gsap.set(headerInner, { height: getExpandedHeight() });
      gsap.set(spacer, { height: getSpacerHeight() });
      if (hamburger) {
        gsap.set(hamburger, { opacity: 0 });
      }
    };

    setInitialState();

    // Create scroll-linked animation
    const scrollTriggerDistance = 100;

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: document.body,
        start: "top top",
        end: `+=${scrollTriggerDistance}`,
        scrub: 0.5,
        invalidateOnRefresh: true,
        onRefresh: () => {
          if (window.scrollY === 0) {
            setInitialState();
          }
        },
      },
    });

    // Animate from expanded to collapsed
    tl.fromTo(
      logo,
      {
        width: () => getExpandedLogoWidth(),
        marginTop: () => (isMobile() ? 0 : 37),
        x: 0,
      },
      {
        width: () => getCollapsedLogoWidth(),
        marginTop: () => getCollapsedMarginTop(),
        x: () => (isMobile() ? -(window.innerWidth - 32 - getCollapsedLogoWidth()) / 2 : 0),
        ease: "none",
      },
      0
    )
      .fromTo(
        headerInner,
        {
          height: () => getExpandedHeight(),
        },
        {
          height: () => getCollapsedHeight(),
          ease: "none",
        },
        0
      )
      .fromTo(
        spacer,
        {
          height: () => getSpacerHeight(),
        },
        {
          height: () => getCollapsedSpacerHeight(),
          ease: "none",
        },
        0
      );

    // Animate hamburger on mobile
    if (hamburger) {
      tl.fromTo(
        hamburger,
        { opacity: 0 },
        { opacity: 1, ease: "none" },
        0
      );
    }

    // Debounced resize handler
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => ScrollTrigger.refresh(), 100);
    });

    // Also refresh on orientation change
    window.addEventListener("orientationchange", () => {
      setTimeout(() => ScrollTrigger.refresh(), 100);
    });
  }
</script>
